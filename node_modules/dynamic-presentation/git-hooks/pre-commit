#!/usr/bin/env sh

# See https://stackoverflow.com/a/33431504
case ${SKIP_HOOKS:-no} in
    yes) exit 0;;
    no)  ;;
    *)   echo "WARNING: Mystery value '${SKIP_HOOKS}' for SKIP_HOOKS.";;
esac

# Get all staged non-deleted files.
FILES=$(git diff-index --cached HEAD | grep -vP '^([^ ]* ){4}D' | cut -f2 | sed 's@^@/var/www/@g')
PRETTIERFILES=$(printf '%s\n' $FILES | grep '\.\(css\|html\|js\|json\|less\|md\|scss\|yaml\|yml\)$')
JSFILES=$(printf '%s\n' $FILES | grep '\.js$')
TESTJSFILES=$(printf '%s\n' $FILES | grep '\.test\.js$')

echo $PRETTIERFILES
echo $JSFILES
echo $TESTJSFILES

EXIT_CODE=0

test "$DART" || DART=dart

if test "$PRETTIERFILES"; then
    if ! $DART +npx prettierx --check $PRETTIERFILES > /dev/null; then
        $DART +npx prettierx  --write $PRETTIERFILES
        $DART +npx prettierx  --check $PRETTIERFILES \
        && echo "Please stage changes made by prettier."
        EXIT_CODE=1
    fi
fi

if test "$JSFILES"; then
    if ! $DART +npx semistandard $JSFILES > /dev/null; then
        $DART +npx semistandard --fix $JSFILES
        $DART +npx semistandard -v $JSFILES \
        && echo "Please stage changes made by semistandard."
        EXIT_CODE=1
    fi
fi

if test "$TESTJSFILES"; then
    $DART +npx jest $TESTJSFILES
    test $? -eq 0 || EXIT_CODE=1
fi

exit $EXIT_CODE
